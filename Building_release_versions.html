<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Building Firefox, SeaMonkey and Thunderbird releases</title>
    <style>
.red {
background-color: #FFdddd;
}
.gray {
background-color: #e7e7e7;
}
.green {
background-color: #E7F5E7;
}
.thtwo {
background-color: #Fafafa;
border: dotted 1px;
}
.appx {
background-color: #Fafafa;
}
div {
padding: 5px;
white-space: pre-wrap;
}
code {
padding: 5px;
display: inline-block;
white-space: pre-wrap;
margin: 5px 0;
}
div code {
margin: 10px 0;
}
.console {
border-left: 3px solid lightgrey;
margin-left: 15px;
}
a, a:visited {
text-decoration: none;
font-style: oblique;
color: #0000c5;
}
a.extlink, a:visited.extlink {
color: #c50000;
}
a.intlink, a:visited.intlink {
color: #00c500;
}
.return {
font-size: 80%;
}
hr {
width: 100%;
height: 2px;
}
</style>
  </head>

  <body>
    <h3> Building Firefox, SeaMonkey and Thunderbird releases from mercurial repositories</h3>
    Build <span style="background:#FFFADD;">Firefox</span> with gtk2, mach,
    rust; and package it to install to /opt/firefox-{version} ...<br>
    and/or <span style="background:#E5F1FF;">SeaMonkey</span> and/or <span style="background:#F8F8F8">Thunderbird</span> based on that Firefox source.<br>
    <p>With <span class="red">single localization</span> and <span class="green">user preferences</span> options and <span class="thtwo">32-bit build adjustments</span>.</p>
    <p>This page has been laid out around a distro-independent <span class="gray">build script</span>, except for packaging, which is Slackware specific, but I assume could be adapted for packaging for other distros, or as a tar archive.
<br>
Packaging from the 'mach' built packages is generic.<br>
    <p>
    <b>References</b><br>
    <a class="extlink" href="http://www.linuxfromscratch.org/blfs/view/svn/xsoft/firefox.html">LFS</a>
    for mozconfig setup and the inspiration to do this<br>
    <a class="extlink" href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Build_Instructions/Simple_Firefox_build">Simple Firefox build</a><br>
    <a class="extlink" href="https://developer.mozilla.org/en-US/docs/Simple_Firefox_build/Linux_and_MacOS_build_preparation">Linux Build Prerequisites</a><br>
    &hellip; and other Mozilla Developer pages &hellip;
    <p>
    <b>Resources</b><br>
    Plenty of disk space - I tried to build this in ~6G ram but it ran out of space.<br>
    Needs about that much HD space.
    <b>

<p>
Build time</b>
<br><i>Latest builds 2016-10-29.</i>
<br>
On a dual-core 2.2 GHz machine, with 'MOZ_MAKE_FLAGS="-j2"', the build times were:<br>
    Firefox-49.0.3 ~ 85 mins <br>
    SeaMonkey-2.46 ~ 92 mins <br>
    Thunderbird-49.0 ~ 92 mins<br>
Higher values for '-j' made no difference to these best build times and were prone to timing errors.
<p>
<i>Latest builds 2017-03-20 using rust-1.15.1</i><br>
From Firefox 50.0, I'm using a 2x quad-core 3GHz machine with 'MOZ_MAKE_FLAGS="-j10"' which builds without any timing errors.
<br>The build times were:<br>
    Firefox-52.0.2 ~ 21 mins <br>
    SeaMonkey-2.49 ~ 22 mins<br>
    Thunderbird-52.0 ~ 22 mins

    <p>
    <b>Directory structure</b><br>
    The build is done within this directory structure [key directories only]:<br>
    <code>$MOZ_BUILD
├── comm-release				# mercurial clone
│   └── mozilla					# unpacked mozilla-release bundle
│       └── extensions
│           └── {irc,inspector}			# mercurial clones
<span class="red">├── l10n
│   ├── $L10N					# mercurial clone
│   └── merge-$L10N 				# updated $L10N files</span>
├── sources
│   ├── autoconf-2.13				# source archive
│   ├── mozilla-release				# mercurial bundle
│   └── rust					# latest binaries
├── firefox-build-dir
├── seamonkey-build-dir
├── thunderbird-build-dir
├── packaging-FF
│   └── lib					# package source to install to /opt/firefox-{version}
├── packaging-SM
│   └── lib					# package source to install to /opt/seamonkey-{version}
├── packaging-TB
│   └── lib					# package source to install to /opt/thunderbird-{version}
└── built
    ├── firefox-{version}<span class="red">$L10N</span>-$ARCH.txz	# the Firefox Slackware package
    ├── seamonkey-{version}<span class="red">$L10N</span>-$ARCH.txz	# the SeaMonkey Slackware package
    └── thunderbird-{version}<span class="red">$L10N</span>-$ARCH.txz	# the Thunderbird Slackware package
</code>
    <p>


    <b>Create build directories</b><br>
    <code class="gray">mkdir /Moz-build
export MOZ_BUILD=/Moz-build
mkdir -p $MOZ_BUILD/{packaging-{FF,SM,TB},built,sources,l10n}
</code>

    <p>
<b>Set variables</b>
<br>
'uname -m' won't identify the architecture where a 64-bit kernel is being used for a 32-bit system &hellip;<br>
looking for '/lib64' is simple, or ARCH can be set manually.
<br><code class="gray">export ARCH=x86_64
[[ ! -d /lib64 ]] &amp;&amp; export ARCH=i686
<span class="red">export L10N=en-GB</span>
<span class="red">export LOCN=-$(echo $L10N | tr - _)</span>
</code>

<p>

<b>Mercurial bundles and repositories</b><br>
mozilla-release is downloaded as a bundle from https://hg.cdn.mozilla.net and is unbundled to a sub-directory of comm-release.<br>
The key advantage of using a bundle rather than cloning the repo is that an interrupted download can be resumed. <br>
It also puts less of a load on the server - see <a class="extlink" href="http://gregoryszorc.com/blog/2015/05/29/faster-cloning-from-hg.mozilla.org-with-server-provided-bundles/">here</a> and <a class="extlink" href="http://gregoryszorc.com/blog/2015/10/22/cloning-improvements-in-mercurial-3.6/">here</a>.
<p>
comm-release, chatzilla, inspector, and locale have to be cloned as no bundle is available.
<p>comm-release<br>
<code class="gray">(cd $MOZ_BUILD
hg clone https://hg.mozilla.org/releases/comm-release/
)
</code>


<p>mozilla-release<br>
<code class="gray">(cd $MOZ_BUILD/sources
# get mozilla-release bundle
wget -O bundles https://hg.cdn.mozilla.net/
BUNDLE=$(grep mozilla-release.*bzip2 bundles | sed 's|.*href="||;s|">.*$||')
wget -O mozilla-release.bzip2.hg https://hg.cdn.mozilla.net/$BUNDLE)

(cd $MOZ_BUILD/comm-release
# unbundle mozilla-release
hg init mozilla
hg unbundle $MOZ_BUILD/sources/mozilla-release.bzip2.hg -R mozilla
# set default repo to pull from
cat &gt; mozilla/.hg/hgrc &lt;&lt; "EOF"
[paths]
default = https://hg.mozilla.org/releases/mozilla-release/
EOF
# get new changesets since bundle was created
hg pull -R mozilla
# update local repo
hg update -R mozilla
)
</code>

<p> Add chatzilla [IRC] and inspector [DOM] repos if required.
<br>These will be downloaded to $MOZ_BUILD/comm-release/mozilla/extensions/{irc,inspector}
<br>
<code class="green">(cd $MOZ_BUILD/comm-release
python client.py --skip-comm --skip-mozilla checkout
)
</code>

<p>
non-US locale<br>
<code class="red">(cd $MOZ_BUILD/l10n/
hg clone https://hg.mozilla.org/releases/l10n/mozilla-release/$L10N/)
</code>
<br><a name="CompareLocReturn"></a>
If the localization has not been updated for new files or strings in the en-US locale, then the build will fail or run-time failures will occur on these omissions.
<br>
A check should therefore be made to ensure that there are no missing files or strings in the localization,
<br>
which is done with <span class="red"><a href="#CompareLoc">compare-locales</a></span> [section includes setting up searchplugins for locale].

<a name="UpdateRepoReturn"></a>
<p>
Once these locally cloned repositories have been set up, they can be <a href="#UpdateRepo">kept up-to-date for future builds</a>.
<p>
<b>Autoconf</b>
<br>Building needs autoconf-2.13 for the '--localdir=' option which the later versions don't have.
<br>Build and install to temporary directory for use with this build only.
<br>
<code class="gray">(cd $MOZ_BUILD/sources
wget http://ftpmirror.gnu.org/autoconf/autoconf-2.13.tar.gz

tar xf autoconf-2.13.tar.gz
cd autoconf-2.13
./configure --prefix=$MOZ_BUILD/sources/autoconf_213
make
make install)
</code>
<br>
autoconf is now installed at $MOZ_BUILD/sources/autoconf_213/bin/autoconf and this path is included in mozconfig.common.
<p>

<b>Rust</b>
<br>
What is rust and why should I use it? - see <a class="extlink" href="https://hacks.mozilla.org/2016/07/shipping-rust-in-firefox/">here</a> and <a class="extlink" href="http://www.zdnet.com/article/mozilla-begins-process-of-letting-firefox-rust/">here</a>.
<br>
<code class="gray">(cd $MOZ_BUILD/sources/
wget https://www.rust-lang.org/en-US/other-installers.html
URL=$(grep "rust-[1-9].*$ARCH-unknown-linux-gnu.tar.gz\">" other-installers.html | sed 's|.*href="||;s|">.*$||')
wget $URL

tar xf rust*$ARCH-unknown-linux-gnu.tar.gz
cd rust*$ARCH-unknown-linux-gnu
./install.sh --prefix=$MOZ_BUILD/sources/rust-$ARCH --without=rust-docs)
</code>
<br>Building with rust enabled requires rustc to be in the PATH which is set pre-build as a shell variable.
<p>
The pre-built versions of rust available for Linux are for ARCH={x86_64,i686}.
<br>But the hard-coded target for rustc in the repo source is 'i586-unknown-linux-gnu' and if doing a build for i686 32-bit, this error will occur:
<code class="console"> DEBUG: Executing: `/Moz-build/sources/rust-i686/bin/rustc --crate-type staticlib --target=i586-unknown-linux-gnu -o /tmp/conftestHkeIAq.rlib /tmp/conftest3c_qXZ.rs`
 DEBUG: The command returned non-zero exit status 101.
 DEBUG: Its error output was:
 DEBUG: | error[E0463]: can't find crate for `std`
&nbsp;&nbsp;&nbsp;&vellip;
 ERROR: Cannot compile for i686-pc-linux-gnu with /Moz-build/sources/rust-i686/bin/rustc
</code>
<br>which is because the installed rustc 'crate' is for i686 not i586.
<br>So point the build to the correct 'crate':
<br><code class="thtwo">[[ $ARCH == i686 ]] &amp;&amp; sed -i 's|i586-unknown-linux-gnu|i686-unknown-linux-gnu|' $MOZ_BUILD/comm-release/mozilla/build/moz.configure/rust.configure
</code>

<p>
<b>Create mozconfigs</b>
<br>
As three packages are being built, set up mozconfig.{common,firefox,seamonkey,thunderbird}
<br>
'mach' will install wherever '--prefix=' points to.
<br>
Other options can be seen in 'old-configure'
<p>
mozconfig.common:
<br>
<code class="gray">(cd $MOZ_BUILD/comm-release/mozilla
cat &gt; mozconfig.common &lt;&lt; "EOF"
## Note: The build system automatically makes an intelligent guess for how
## many CPU cores to use when building. The option below is typically not needed.
## Most modern systems have multiple cores or CPUs, and they can be optionally
## used concurrently to make the build faster. The -j flag controls how many
## parallel builds will run concurrently. You will see (diminishing) returns up
## to a value approximately 1.5× to 2.0× the number of cores on your system.
## If your machine is overheating, you might want to try a lower value, e.g. -j1.
## If you get timing errors [gmake[4]: *** Waiting for unfinished jobs.... is a
## sign of trouble], you might want to try the build without X or anything else
## running, or a lower value, e.g. -j1.
mk_add_options MOZ_MAKE_FLAGS="-j2"

# If you have installed DBus-Glib comment out this line:
#ac_add_options --disable-dbus

# If you have installed dbus-glib, and you have installed (or will install)
# wireless-tools, and you wish to use geolocation web services, comment out
# this line
ac_add_options --disable-necko-wifi

# Uncomment this option if you wish to build with gtk+-2
ac_add_options --enable-default-toolkit=cairo-gtk2

# Uncomment this option if you don't have PulseAudio installed
#ac_add_options --disable-pulseaudio

# If you have installed GConf, comment out this line
ac_add_options --disable-gconf

ac_add_options --disable-crashreporter
ac_add_options --disable-updater
ac_add_options --disable-tests

ac_add_options --enable-optimize

ac_add_options --enable-gio
ac_add_options --disable-official-branding
ac_add_options --enable-safe-browsing
ac_add_options --enable-url-classifier

ac_add_options --with-pthreads
ac_add_options --with-system-zlib

mk_add_options AUTOCONF=$MOZ_BUILD/sources/autoconf_213/bin/autoconf

# enable rust for use where the source supports it
## mk_add_options has no affect - rustc has to be in the PATH
#mk_add_options RUSTC="$MOZ_BUILD/sources/rust-$ARCH/bin/rustc"
ac_add_options --enable-rust

EOF
)
</code>

<p><a name="ChrootReturn"></a>
To be added for 32-bit version build where a 64-bit kernel is being used:<br>
[<i>Can be built in a <a href="#Chroot">chroot</a> within a 64-bit system</i>]
<br>
<code class="thtwo">(cd $MOZ_BUILD/comm-release/mozilla
cat &gt;&gt; mozconfig.common &lt;&lt; "EOF"
# For 32 bit version
ac_add_options --target=i686-pc-linux-gnu
ac_add_options --host=i686-pc-linux-gnu

EOF
)
</code>


<p>
For optional single locale version:<br>
<code class="red">(cd $MOZ_BUILD/comm-release/mozilla
cat &gt;&gt; mozconfig.common &lt;&lt; "EOF"
# To build a single locale version
mk_add_options MOZ_CO_LOCALES=$L10N
ac_add_options --enable-ui-locale=$L10N
ac_add_options --with-l10n-base=$MOZ_BUILD/l10n

EOF
)
</code>


<p>
mozconfig.firefox:
<br>
<code class="gray">(cd $MOZ_BUILD/comm-release/mozilla
cat &gt; mozconfig.firefox &lt;&lt; "EOF"
## include the common mozconfig
source $MOZ_BUILD/comm-release/mozilla/mozconfig.common

## for Firefox build
ac_add_options --enable-application=browser
mk_add_options MOZ_OBJDIR=$MOZ_BUILD/firefox-build-dir
ac_add_options --prefix=$MOZ_BUILD/packaging-FF

EOF
)
</code>

<p>
mozconfig.seamonkey:
<br>

<code class="gray">(cd $MOZ_BUILD/comm-release
cat &gt; mozconfig.seamonkey &lt;&lt; "EOF"
## include the common mozconfig
source $MOZ_BUILD/comm-release/mozilla/mozconfig.common

## for SeaMonkey build
ac_add_options --enable-application=suite
mk_add_options MOZ_OBJDIR=$MOZ_BUILD/seamonkey-build-dir
ac_add_options --prefix=$MOZ_BUILD/packaging-SM

## the default extensions - 'inspector irc' - are not in the source
## and need to be cloned from their repos with 'client.py'
## uncomment this option if not included in the build
<span class="green">#ac_add_options --disable-extensions</span>

EOF
)
</code>

<p>mozconfig.thunderbird:
<br>
<code class="gray">(cd $MOZ_BUILD/comm-release
cat &gt; mozconfig.thunderbird &lt;&lt; "EOF"
## include the common mozconfig
source $MOZ_BUILD/comm-release/mozilla/mozconfig.common

## for Thunderbird build
ac_add_options --enable-application=mail
mk_add_options MOZ_OBJDIR=$MOZ_BUILD/thunderbird-build-dir
ac_add_options --prefix=$MOZ_BUILD/packaging-TB

EOF
)
</code>

<p>
If not building Firefox, skip to <b><a href="#Building_SeaMonkeyThunderbird">Building SeaMonkey/Thunderbird</a></b>
<p>
<a name="BuildingFFReturn"></a>
<div style="background: #FFFADD;"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAADBElEQVR42qWTa0jTURiHs6sWSmnp
vCyZ2/9sS0vwkiuibFp20zStnBElzktKYSubWgyJCnVWaCS2LiRipXZDMyv8oq6yskRXXip1S2eR
TiXSLuj/11nESKpPHXg4nHNenvO+5zJltrvvf/HHhOLxIDep/mNRbN1An7zexMq1w2xsvcmwp+FD
vvxet8s/BaZs0RbZZa085MLjUVJQh4BSLaR3+7G+dgCSaiMCy3QobuoYLq84m/ntuaPVJEGf0nN+
VxKZUGUqJxKzFLh6Pgxb1IfgdqUNvFsG2JW9BbegEUlU2tNzH02VyTWTBNU7xGs7ZAS9qUIYjzLQ
F/AQkJ4Lt1O3MeNiK2w0LbDPeQjvjNsYGdTiU68aA032oRbBo1gm/108g3f7CIwqAv1xD7SnrsaZ
rBQ45DRggaoWnIPV4MSXQFN5AxjMRv+LaSctgrY4gVG/i8CQQtCnJHh/mo9j8eEgqWVwU1RhQVI5
bGXnYLM5DxV3LoI1FaK9Rmy0CHQywXj3DrpzAoEuWgjVuqVYvF2BOTEazJEVwTpUDes1WbCW7MX3
kRKwQ4dRfUHKfm92mvpT8CxCMPE6iqCHZvEkSIjSGAmcAlPgtukAQuTxcAhOg61PItz9ZPjSEYRx
gxCd1xaOWjKoDGZadBsJ3m4neCOjmSQSdCtE0KcT1MQJERoeAXtRNFTK5Rh76IrRxnloOc69YxGU
rCDKxpUEbWEEXTLKToJLwV6IEvrD3WMDHD3CwPeQ4lUxH0PXXdF5goeqreIjFkGGn5dDjZ/g49PA
X5JoWs5ugluRXkhe5g/1Bl/0ZhIM5ghgSGNQFSlim6OYVZNeosaT2fbAm7DmTMzlmM+kK8Z8LvR6
Exj07WWglzN4uVXA1ofw8/54yrTZJTs6594UCb42SAieB1HRJoL2cILOSILWcAY3VjDsfh7nPI11
+ZtgOmURf5Z1upLj3HyZzxurWiJgK334bLH3ws9qsevrSKe5hTRmGcXmn7/RvEjhUswD6UwrqzW0
l1D4FFuK1e/xPwCy1KrpkpT5rQAAAABJRU5ErkJggg=="><b> Building Firefox</b>
<code class="gray">cd $MOZ_BUILD/comm-release/mozilla/
</code>
To enable <a class="extlink" href="https://wiki.mozilla.org/Electrolysis">e10s</a> by default:
<code class="green">sed -i 's|pref("browser.tabs.remote.autostart", false);|pref("browser.tabs.remote.autostart", true);|' browser/app/profile/firefox.js
</code>
Where the server or meta tags don't identify file encoding, setting default fallback encoding to UTF-8 has been <a class="extlink" href="https://bugzilla.mozilla.org/show_bug.cgi?id=967981#c4">deliberately blocked</a> in Firefox.
To allow the default to be set to UTF-8, add Unicode option to "Preferences|Content|Fonts &amp; Colors|Advanced|Fallback Text Encoding" menu.
<code class="green">## remove UTF-8 block:
sed -i 's|(mFallback).*$|(mFallback)) {|;/UTF-8/d' dom/encoding/FallbackEncoding.cpp

## add UTF-8/Unicode option:
sed -i '272i\            &lt;menuitem label="\&amp;languages.customize.Fallback.unicode;"     value="UTF-8"/&gt;' browser/components/preferences/fonts.xul
sed -i '104i&lt;!ENTITY languages.customize.Fallback.unicode     "Unicode"&gt;' browser/locales/en-US/chrome/browser/preferences/fonts.dtd

## set "Fallback Text Encoding" to 'Unicode' by default
## otherwise, "Fallback Text Encoding" will default to 'Default for Current Locale':
sed -i 's|fallback.override.*$|fallback.override",      "UTF-8");|' modules/libpref/init/all.js

## replace/remove 'legacy' reference in menu:
sed -i 's|Legacy|Unidentified|;s|legacy content|content|' browser/locales/en-US/chrome/browser/preferences/fonts.dtd

<code class="red">(cd $MOZ_BUILD/l10n
## check for fonts.dtd in merge-$L10N, and copy from $L10N if not there
[[ ! -e merge-$L10N/browser/chrome/browser/preferences/fonts.dtd ]] \
&amp;&amp; mkdir -p merge-$L10N/browser/chrome/browser/preferences/ \
&amp;&amp; cp $L10N/browser/chrome/browser/preferences/fonts.dtd \
merge-$L10N/browser/chrome/browser/preferences/fonts.dtd

## modify the localized fonts.dtd in the merge directory:
sed -i -e 's|Legacy|Unidentified|;s|legacy content|content|' \
-e '104i&lt;!ENTITY languages.customize.Fallback.unicode     "Unicode">' \
merge-$L10N/browser/chrome/browser/preferences/fonts.dtd)
</code>
</code>
<code class="gray">export PATH=$MOZ_BUILD/sources/rust-$ARCH/bin:$PATH
export NO_MERCURIAL_SETUP_CHECK=1
export MOZCONFIG=$MOZ_BUILD/comm-release/mozilla/mozconfig.firefox
<span class="red">[[ -e $MOZ_BUILD/l10n/merge-$L10N ]] &amp;&amp; export LOCALE_MERGEDIR=$MOZ_BUILD/l10n/merge-$L10N</span>
./mach build
</code>
A successful build will end with a message like:
<code class="console">84:49.42 We know it took a while, but your build finally finished successfully!
To view resource usage of the build, run |mach resource-usage|.
To take your build for a test drive, run: |mach run|
</code>
<b>Installation</b><a name="MachPackageReturn"></a>
Use either './mach install' <a href="#MachPackage">or './mach package'</a>

To avoid this build failure on installation:
<code class="console">Error: ...browser/installer/package-manifest.in:50: Missing file(s): bin/dictionaries/*</code>
comment out line 50 in package-manifest.in &hellip;

<b style="color: darkblue;">OR</b> download and install a dictionary:
Links to dictionaries available at <a class="extlink" href="https://addons.mozilla.org/language-tools/">Mozilla addons</a>
<code class="red">(cd $MOZ_BUILD/sources
wget https://addons.mozilla.org/firefox/downloads/latest/british-english-dictionary-2/addon-461570-latest.xpi)
(cd $MOZ_BUILD/firefox-build-dir/dist/bin
unzip $MOZ_BUILD/sources/addon-461570-latest.xpi dictionaries/*)
</code>
Let's take it for a test drive:
<code>./mach run
</code>
Install to --prefix, which has been set to $MOZ_BUILD/packaging-FF:
<code class="gray">./mach install
</code>
<b>Create package</b>
Includes setting up relative link for /usr/bin/firefox &hellip;
<code class="gray">cd ../../packaging-FF/lib
mkdir -p pkg/{opt,usr/bin}
mv firefox-[0-9]* pkg/opt
(cd pkg/usr/bin
ln -s ../../opt/firefox-*/firefox .)
cd pkg
makepkg -l y -c n ../../../built/firefox-$(cat $MOZ_BUILD/comm-release/mozilla/browser/config/version.txt)${LOCN:-}-${ARCH:-}.txz
</code>
</div>
<p>


<br>
<b><a name="Building_SeaMonkeyThunderbird"></a>
Building SeaMonkey/Thunderbird</b>
<br>
<a name="BuildingSMReturn"></a>
<div style="background: #E5F1FF;"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJ
bWFnZVJlYWR5ccllPAAAAuxJREFUOE9lUktME1EUPW9mWqbFtmPDLxFCiYghfiiCESKRmhgWuqAr
o2EhMWqEjWhYEF2IO6Ms0AWRlbpg4wbcaIzRBXFBNJrSYPxA+CqRXwv90Ol0Zp7vTamg3uTm3pe8
c8+5H4L/rK+8rMzZ5Xbb/fxlmtwpVDWzvrS0OaKq3U93/iY7H4ry4LbP5+pVFNkC6boJw6CW81zT
dKyuqqHl5WQ70DP+VwGHo+9aXV1JP89zIMMwLWDTqb243tMEQRJAUyrqDwzORqOqnxXZkLLwe81V
Vd5+Xd8G5QoUF+fjVu8JTCwBYz8ojqYWYbeLPlmWWDs4aRWoqHD322wi61O3QDnJPJ4+74eaAb6s
UHjsBpoafCgqciKR0ALA/VYBuFsjy6Kfg9NpgxUxsJ3rCAar8GYG+LwCpDQT31ZMtLRUsHkYEEXa
LpWWugJutwNra8kdfWdjR0ct0lTA7DoQT7PZUIJkxoTHkweXy4mCAk9Aqq8/rLQGj4PydVGAbjlf
X01DBgMf2Ap1Aq9MIbKR/9ygCASOoLikEZOT84oUDmusnziTAwjMTcbs9UpobHTgu2EHUwqFgSMJ
HaVugjKPiBfPNITDKuJxHdLc3EYoEkkwybA8Kx9o68zD6KqIDGurtshA3EPgYYXy1imGhmKw2cBm
FAlJhjEdSqUqmWSvBeTyHw7sxvCahF1s6k7BgMsuYH8BoLFVXroYhSwTq0Ay+Su0dUgvHxNyqJ1n
HDxWKONstW5d2XyM4Fghwae3aQw+SjJWCkkijHAZExOvfFuHNN4FuIM3bh5UJssd6Nyjw9wEFqcN
rH3N4MpICqkULFbOToiGhYVwL9A9ZymglJaPfEw+UfOcAWdEw9VzEfY5K5Oz8cjfEqPTtAhmZt73
xmIX7nCswMDD7+bpbLUvH5XqcrDtzOsRUUxaTNwdjmyUJA2x2PTs1NRoew7MjbACzSyuE0LG8cf6
yr3efUG7XVY4q8DuNRqdD8Xjl5/jH/sNIBmHpcHZfUMAAAAASUVORK5CYII="><b> Building SeaMonkey</b>
<code class="gray">cd $MOZ_BUILD/comm-release
</code>
To enable <a class="extlink" href="https://wiki.mozilla.org/Electrolysis">e10s</a> by default:
<code class="green">echo 'pref("browser.tabs.remote.autostart", true);' >> suite/browser/browser-prefs.js
echo 'pref("browser.tabs.remote.desktopbehavior", true);' >> suite/browser/browser-prefs.js
</code>
To include the search box by default:
<code class="green">sed -i 's|nav-bar-inner,|nav-bar-inner,search-container,|' suite/browser/navigator.xul
</code>
<code class="gray">export PATH=$MOZ_BUILD/sources/rust-$ARCH/bin:$PATH
export NO_MERCURIAL_SETUP_CHECK=1
export MOZCONFIG=$MOZ_BUILD/comm-release/mozconfig.seamonkey
<span class="red">[[ -e $MOZ_BUILD/l10n/merge-$L10N ]] &amp;&amp; export LOCALE_MERGEDIR=$MOZ_BUILD/l10n/merge-$L10N</span>
./mozilla/mach build
</code>
A successful build will end with a message like:
<code class="console">92:00.04 We know it took a while, but your build finally finished successfully!
To view resource usage of the build, run |mach resource-usage|.
To take your build for a test drive, run: |mach run|</code>
<b>Installation</b>
Install a dictionary [download as for Firefox]:
<code class="red">(cd $MOZ_BUILD/seamonkey-build-dir/dist/bin
unzip $MOZ_BUILD/sources/addon-461570-latest.xpi dictionaries/*)
</code>
Add searchplugins of choice::
<code class="red">rm $MOZ_BUILD/seamonkey-build-dir/dist/bin/searchplugins/google*
cp $MOZ_BUILD/comm-release/mozilla/browser/locales/searchplugins/{amazon,eBay,google}-$L10N.xml \
$MOZ_BUILD/seamonkey-build-dir/dist/bin/searchplugins/
</code>
Let's take it for a test drive:
<code>./mozilla/mach run
</code>
Install to --prefix, which has been set to $MOZ_BUILD/packaging-SM:
<code class="gray">./mozilla/mach install
</code>
<b>Create package</b>
Includes setting up relative link for /usr/bin/seamonkey &hellip;
<code class="gray">cd ../packaging-SM/lib
mkdir -p pkg/{opt,usr/bin}
mv seamonkey-[0-9]* pkg/opt
(cd pkg/usr/bin
ln -s ../../opt/seamonkey-*/seamonkey .)
cd pkg
makepkg -l y -c n ../../../built/seamonkey-$(cat $MOZ_BUILD/comm-release/suite/config/version.txt)${LOCN:-}-${ARCH:-}.txz
</code>
</div>

<p>
<a name="BuildingTBReturn"></a>
<div style="background:#F4f4f4"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A
/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sIDw0JOVohvckAAATpSURBVDjL
rZV7aFNnGMaf7+QkOUmTaG+x96qb1ehab+i8TKtT62VCq2ODsQvCZMLYGIx1F8YYQ53MiezixA1F
1DGdwlTQOaUVhU5rtWrtnNraJrXJ0ubWnJxzcnKu3/5wc7roHGwPfPDxfrw/Xh5eng94iJKUWjfv
P189unadFQAWbjiC/6TGredAKeVe39zUtG7PBXomKJzFs58NA4DhT299aL/lQQ9njm6HUlm/Y+TY
ESuKfGX0VHt3mRJT3lNGLS7xCOJJ/uYJreqJ9YjfOnnffubvhciFYwCAhrWd08dOrngJHgcVpQTh
YwIxTQpDN16hIF3j5nxc09XyPkbWffTvwIqiWGnH91NnPJ7bDIeOXI9JwkEe125EMJjRYYBAtttK
RY7tKFm2zhs48eGd3uCZQ3fu5G5ouPVIma7rPTrL2Y7bquFymbTtbB85vrMFYkEhmJGFcJkGOM5O
OYYh4VhKDsTM8b81uhdSQ2sundXgv2fiq8f2IhrqhsQn1vLRkE0QJSh6hgb7U+TgnnaseuQK1k+6
hP5bcZS5rJg7sYx4cz10SlU5Vz8+p0sY6P3GBGnMsmLC0ucQ7GhbnkwmVsXDIZqJh3Hz6gD5pTOM
mjwLbkSiaMmZDxfP4/T+g+i6EkK+x0VsrIWonnLrtjYWeizwwq8/7q7J8lilpFG3OyFGwuS7cxGU
ui2YPSYX8UIn9o9ag8MtERToKkZ5q9C6byuSogGbhYEHaXTnzyU93X3utMW2KwtsAFOGV/owGBnA
mBmLMOfRfPiKOMwl7ZicDCMnJcGq6rAYaXisTnBWCl01YOcYlOdb0Wt/DKCYlAVmKFyqxNM5L7+F
Nct98FUUojfgx4SZK/Dq0okY7rCDNVVYTB42jkFJmQfeAhdCoRTKTR7TplRQg/y1ZOwdMMsiIwlk
/Ixl2HukAwdOXcPJqyGIkoyV0ypR7eXRGhyEKvjB+mZjUTGDBXWliNba4bKI6AsoJKPp2WDO6bou
SUPjhHgQn/5wCRoxUN9Qh8FEAm6ksW3DM2g9246yEi8GdCd8xQ6oqowcGxCLilBVFQxhYllgXVU2
Waz27YP9XVg5z4fRE3xYMs6BuKjDH1WgUQa1tdNhmjoqDQOmJkPNZJCWBGTSEjRNg93p/CTLY4fD
dchuc6jJWJTOn16FF6e5sfNcDCFehagasBIKLSNAzUjQZBGKLEGRRYh8EmlJpBaGVQ1V35MF9s1e
FC8oKtpBKYiDpOmsjVfQPyjielCCIhtQdR1SMnYbLqcgC0nw8SiEFE+1jErcebm7py5eOXjfrJg3
88k3C7zFnaXDWDLUm6B5hGDZxHz4vDlQNR2BXj+UtIxkPIp4dAB8Mkk1TSN53uLIpg8+fftu1j1Z
se/rTe4bgVDF6tfevQiGtUlDfQj19aHf3w2Gmqjy+eAdUQRJFJAailMLIcTtyfOvfuOdeT+3tYet
LKtpup4NTsWC32aExPOdHZcjhJpejnPAM8wDG+eE1WqFYRgwTROGpoDnU0O8kG5vamr+KhhLnt57
4PDQAyfu83fVlJaUdEiigK7O81+u3/jFIVmUJzc8Vbc8Nz8/j8JkEpFY/ODREz+BGO1btny+a0RR
UfHFy53OBUvq5fsGc6j/duKdOt1ccFeZBcAByAGQ98dxAXD8uaqSJFRTSv/5n+rpuY7/S78DHAti
UD80RecAAAAASUVORK5CYII="><b> Building Thunderbird</b>
<code class="gray">cd $MOZ_BUILD/comm-release
</code>
<code class="gray">export PATH=$MOZ_BUILD/sources/rust-$ARCH/bin:$PATH
export NO_MERCURIAL_SETUP_CHECK=1
export MOZCONFIG=$MOZ_BUILD/comm-release/mozconfig.thunderbird
<span class="red">[[ -e $MOZ_BUILD/l10n/merge-$L10N ]] &amp;&amp; export LOCALE_MERGEDIR=$MOZ_BUILD/l10n/merge-$L10N</span>
./mozilla/mach build
</code>
A successful build will end with a message like:
<code class="console">92:07.25 We know it took a while, but your build finally finished successfully!
To view resource usage of the build, run |mach resource-usage|.
To take your build for a test drive, run: |mach run|</code>
<b>Installation</b>
Install a dictionary [download as for Firefox]:
<code class="red">(cd $MOZ_BUILD/thunderbird-build-dir/dist/bin
unzip $MOZ_BUILD/sources/addon-461570-latest.xpi dictionaries/*)
</code>
Let's take it for a test drive:
<code>./mozilla/mach run
</code>
Install to --prefix, which has been set to $MOZ_BUILD/packaging-TB:
<code class="gray">./mozilla/mach install
</code>
<b>Create package</b>
Includes setting up relative link for /usr/bin/thunderbird &hellip;
<code class="gray">cd ../packaging-TB/lib
mkdir -p pkg/{opt,usr/bin}
mv thunderbird-[0-9]* pkg/opt
(cd pkg/usr/bin
ln -s ../../opt/thunderbird-*/thunderbird .)
cd pkg
makepkg -l y -c n ../../../built/thunderbird-$(cat $MOZ_BUILD/comm-release/mail/config/version.txt)${LOCN:-}-${ARCH:-}.txz
</code>
</div>
<p>

<hr>
<hr><a name="CompareLoc"></a>
<b>compare-locales</b> - needs python-setuptools. <a class="return" href="#CompareLocReturn">[Return]</a> 
<p>
If new/patched localization files are found, they are included in the build.
<br>
The downside to this is that the additions to the <b>patched</b> files are the default en-US strings, and not line-by-line comparable to the corresponding en-US files, and a build in this case might not be fully localized.
<br>
This should not necessarily be considered a problem because, for example, the Firefox 52.0 en-GB release was built with patched, and new non-localized, files.
<br>
The <b>new</b> files will need to be checked and edited for localization strings.
<p>
Download, build, install.
<br>
<code class="red">(cd $MOZ_BUILD/sources
wget https://hg.mozilla.org/l10n/compare-locales/archive/tip.tar.bz2
tar xf tip.tar.bz2
cd compare-locales*
python setup.py build
python setup.py install)
</code>
<p>
Create a list of default en-US localization files:
<br>
<code class="red">tree -fi $MOZ_BUILD/comm-release/{mozilla,suite,mail} | grep en-US | grep ".*\..*$" > $MOZ_BUILD/sources/en-US-l10n-files
</code>
<p>
Add 'irc' paths for <i>compare-locales</i> to include Chatzilla:
<code class="green"><code class="red">sed -i 's|devtools_client.*$|&amp;\nextensions_irc = mozilla/extensions/irc/locales/l10n.ini|' $MOZ_BUILD/comm-release/suite/locales/l10n.ini
sed -i 's|devtools/client",|&amp; "extensions/irc",|' $MOZ_BUILD/comm-release/suite/locales/filter.py
</code></code>
<p>
Look for new files to be placed in $MOZ_BUILD/l10n/merge-$L10N.
<br>
compare-locales will automatically append any new lines to existing localization files and create copies in merge-$L10N
<br>
<code class="red">echo -e 'mozilla/browser\nsuite\nmail' | while read line ; do
compare-locales -m $MOZ_BUILD/l10n/merge-$L10N $MOZ_BUILD/comm-release/$line/locales/l10n.ini $MOZ_BUILD/l10n $L10N \
| tee $MOZ_BUILD/sources/$(echo $line | tr / _)-compare-locales-output | grep -B 1  "add and localize this file" \
| grep -Ev "\-\-|localize" > $MOZ_BUILD/sources/$(echo $line | tr / _)-new-files
done
</code>
<p>
Find paths of new files and remove duplications where suite/mail use mozilla files &hellip;
<br>
<code class="red">echo -e "mozilla_browser\nsuite\nmail" | while read line ; do
cat $MOZ_BUILD/sources/$line-new-files | while read line ; do
grep $line $MOZ_BUILD/sources/en-US-l10n-files
done ; done | sort -u | tee $MOZ_BUILD/sources/new-files-en-US-path \
| sed 's|locales/en-US/||g' \
| sed "s|^.*/comm-release/mozilla|$MOZ_BUILD/l10n/merge-$L10N|g" \
| sed "s|^.*/comm-release|$MOZ_BUILD/l10n/merge-$L10N|g" > $MOZ_BUILD/sources/new-files-$L10N-path
</code>
<br>
&hellip; and copy the new en-US files to the merge-$L10N directory &hellip;
<br>
<code class="red">(cd $MOZ_BUILD/sources/
paste -d ' ' new-files-en-US-path new-files-$L10N-path | while read line
do
cp $line
done)
</code>
<br>
&hellip; and then edit for localizations:
<br>
<code class="red">MY_FAV_EDITOR=kate
$MY_FAV_EDITOR $(cat $MOZ_BUILD/sources/new-files-$L10N-path)
</code>
<p>
<i>compare-locales</i> doesn't pick up the locale.version change in chatzilla.properties, so if it is in the list of files that have been modified, replace the locale.version string:
<br>
<code class="green"><code class="red">[[ $(grep chatzilla.properties $MOZ_BUILD/sources/suite-compare-locales-output) ]] \
&amp;&amp; sed -i "s|locale.version =.*$|$(grep "locale.version =" \
$MOZ_BUILD/comm-release/mozilla/extensions/irc/locales/en-US/chrome/chatzilla.properties)|" \
$MOZ_BUILD/l10n/merge-en-GB/extensions/irc/chrome/chatzilla.properties
</code></code>
<br>
The en-GB chatzilla.properties file needs a string localized:
<br>
<code class="green"><code class="red">sed -i 's|msg.mnu.motifs.*$|msg.mnu.motifs     = Co\&amp;lour Scheme|' $MOZ_BUILD/l10n/merge-$L10N/extensions/irc/chrome/chatzilla.properties
</code></code>

<p>
A further issue with <i>compare-locales</i> and Chatzilla is that the build doesn't include merge-ab-CD in the comparison with en-US.
<br>
So, copy any new or modified 'irc' files from merge-ab-CD to a new branch in ab-CD.
<br>
This will avoid altering the default branch, leaving it clean for future updates:
<br>
<code class="green"><code class="red">(cd $MOZ_BUILD/l10n/$L10N/
hg branch merge
cp -a ../merge-$L10N/extensions/irc/* extensions/irc
hg commit -m "updated chatzilla files")
</code></code>
<br>
The ab-CD repository is now in the 'merge' branch, where the differences to the 'default' branch are the 'irc/chatzilla' files.
<br>
As this only affects the Seamonkey/Chatzilla build, this branch is equally as valid for Firefox and Thunderbird builds as the default branch; and the ab-CD repository can therefore be left in this branch.

<p>
<b>Set up searchplugins for locale.</b>
<br>
This is en-GB specific, but should be adaptable for other locales &hellip;
<br>
Set up google search on google.co.uk:
<br>
<code class="red">(cd $MOZ_BUILD/comm-release/mozilla/browser/locales/searchplugins/
cat google.xml | sed 's|google.com|google.co.uk|g' > google-en-GB.xml)
</code>
<br>
eBay has been removed from the list of built-in searchplugins.
<br>
To recover it, revert the en-GB repo to a suitable changeset - 2461:da03657b636d will do:
<br>
<code class="red">(cd $MOZ_BUILD/l10n/en-GB
hg update da0365
cp mail/searchplugins/eBay-en-GB.xml $MOZ_BUILD/comm-release/mozilla/browser/locales/searchplugins
[[ $(hg update merge 2>&amp;1>/dev/null) == abort* ]] &amp;&amp; hg update default)
</code>
<br>
Set the default Firefox searchplugins of choice:
<br>
<code class="red">sed -i 's|.*yahoo-en-GB.*wikipedia"|          "google-en-GB", "eBay-en-GB", "amazon-en-GB", "ddg", "wikipedia", "bing", "chambers-en-GB"|' \
$MOZ_BUILD/comm-release/mozilla/browser/locales/search/list.json
</code>

<p>
All done - back to the main build <a class="return" href="#CompareLocReturn">[Return]</a>
<p>

<hr>
<p><a name="UpdateRepo"></a>
<b>Update</b> repositories <a class="return" href="#UpdateRepoReturn">[Return]</a>
<br>Update all cloned repositories prior to any <a class="extlink" href="https://wiki.mozilla.org/RapidRelease/Calendar">future release builds</a>.
<br>Firstly pull down all the changes:
<br><code class="appx">cd $MOZ_BUILD
hg pull -R comm-release
hg pull -R comm-release/mozilla
hg pull -R comm-release/mozilla/extensions/inspector
hg pull -R comm-release/mozilla/extensions/irc
<span class="red">hg pull -R l10n/en-GB
</span></code>
<br>
Then ensure that the repos are updated in the default branch:<br>
<code class="appx">hg update default -R comm-release/
hg update default -R comm-release/mozilla/
hg update default -R comm-release/mozilla/extensions/inspector
hg update default -R comm-release/mozilla/extensions/irc
<span class="red">hg update default -R l10n/en-GB
</span></code>
<br>
This may not work with uncommitted changes in the repo,<br>
<code class="console">abort: uncommitted changes
(commit or update --clean to discard changes)</code><br>
in which case do:<br>
<code class="appx">hg update default -C -R {repo}</code><br>
OR<br>
.. with an error message like:<br>
<code class="console">warning: conflicts while merging &lt;file&gt;! (edit, then use 'hg resolve --mark')</code><br>
edit the offending file, which will be one of those changed above, back to its original state and run:<br>
<code class="appx">hg resolve --mark --cwd {repo}</code><br>
Either of the 'clean' or 'resolve' actions will remove some of the patches applied, so they need to be checked before the next build.
<p>

<hr>
<p><a name="Chroot"></a>
<b>Chroot</b> for 32-bit build <a class="return" href="#ChrootReturn">[Return]</a>
<br>In this scenario, the installed version of rust is 64-bit, so download and install the 32-bit version
<br>
<code class="thtwo">ARCH=i686
(cd $MOZ_BUILD/sources/
wget https://www.rust-lang.org/en-US/other-installers.html
URL=$(grep "rust-[1-9].*$ARCH-unknown-linux-gnu.tar.gz\">" other-installers.html | sed 's|.*href="||;s|">.*$||')
wget $URL

tar xf rust*$ARCH-unknown-linux-gnu.tar.gz
cd rust*$ARCH-unknown-linux-gnu
./install.sh --prefix=$MOZ_BUILD/sources/rust-$ARCH --without=rust-docs)
</code>
<p>Set up and switch to chroot.<br>
<b><i>Either</i></b>:<br>
[1] Build in a 32-bit environment which has been installed in a directory, for example /chrt.<br>
<code class="thtwo">CHRT=/chrt
</code><br>
<b><i>Or</i></b>:<br>
Mount 32-bit installation from either [2] VFS (offset according to fdisk setup), or [3] partition:<br>
<code class="thtwo">CHRT=/chrt
mkdir $CHRT
[2] mount -o loop -o offset=$((2048*512)) /VFS $CHRT
or
[3] mount /dev/sdx $CHRT
</code><br>
<b><i>Then</i></b>:<br>
<code class="thtwo">mount --bind /dev $CHRT/dev
mount -t proc proc $CHRT/proc

mkdir $CHRT$MOZ_BUILD
mount -B $MOZ_BUILD $CHRT$MOZ_BUILD

chroot $CHRT /bin/env MOZ_BUILD=$MOZ_BUILD ARCH=$ARCH L10N=$L10N /bin/bash

. /etc/profile
</code>
<br>&nbsp;&hellip; and then continue as for 'Building <a href="#BuildingFFReturn">Firefox</a>/<a href="#BuildingSMReturn">SeaMonkey</a>/<a href="#BuildingTBReturn">Thunderbird</a>'
<p>

<p>The macro path for autoconf is set as an absolute path in the autoconf script and if MOZ_BUILD is not the same in both the host and chroot environments, would fail to find the macros.
<br>In this case, autoconf would have to be re-compiled within this chroot &hellip;
<br>&hellip; or, just edit the path <span class="thtwo">${AC_MACRODIR=/Moz-build/sources/autoconf_213/share/autoconf}</span> in the autoconf script to show the path in the chroot.


<hr>
<p><a name="MachPackage"></a>
<b>Using './mach package'</b>&nbsp;<a class="return" href="#MachPackageReturn">[Return]</a>
<br>
<code class="gray">./mach package
</code>
<br>
will create:
<br>
<code class="console">$MOZ_BUILD/firefox-build-dir/dist/firefox-{version}.<span class="red">en-GB.</span>linux-x86_64.tar.bz2
<span class="red">$MOZ_BUILD/firefox-build-dir/dist/linux-x86_64/xpi/firefox-{version}.en-GB.langpack.xpi
</span></code>

<hr>
<p>
Any alterations to the source code may only be relevant to its revision at the time of the build.
<p>
<u>Page revisions for 52.0 builds</u>:
<br>
2017-03-10 <span style="text-decoration: line-through">to place patches for en-GB localization into one patch file.</span>
<br>
2017-03-20 Firefox security updates, and to include compare-locales and new searchplugins locations.
<br>
</body></html>
